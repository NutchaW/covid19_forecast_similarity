---
title: "Forecasting Model Similarity"
author: "Johannes Bracher, Evan Ray, Nick Reich, Nutcha Wattanachit, Li Shandross"
date: "06/10/2021"
header-includes:
   - \usepackage{tabularx}
   - \usepackage{hyperref}
   - \usepackage{wrapfig}
   - \usepackage{float}
   - \usepackage{colortbl}
   - \usepackage{pdflscape}
   - \usepackage{tabu}
   - \usepackage{xcolor}
output:
  pdf_document:
        latex_engine: xelatex
---

```{r setup, include=FALSE}
library(tidyverse)
library(energy)
library(knitr)
library(data.table)
library(covidHubUtils)
#devtools::install_github("reichlab/covidHubUtils")
library(lubridate)
library(zoltr)
library(igraph)
library(gtools)
library(gridExtra)
knitr::opts_chunk$set(echo=FALSE,
                       comment = FALSE, message=FALSE, fig.show= 'hold',fig.pos="H",table.placement='H',
                       fig.align = 'center')
```


# COVID-19 Forecasting Model Similarity Analysis for 1-4 Week Ahead Incident Death 

## 5 locations with the highest number of COVID-19 deaths by the end of February 2021

The pairwise approximated Cramer's distances are calculated for the models that have complete submissions for all target, all 5 locations with the highest number of COVID-19 deaths by the end of February 2021, all probability levels, from the target end date of October, 17th 2020 to May 29th, 2021 .

```{r}
source("./functions/distance_func_script.R")
# set targets for analysis
target_horizon <- 1:4
target_var <- c("inc death","inc case")
# read in model metadata
metadata <- read.csv("./metadata_categorized.csv") 
# each target will have different sets of models based on the current filtering
## high count
wide_frame_death <- read.csv("./data/quantile_frame.csv") 
wide_frame_case <- read.csv("./data/quantile_frame_inc.csv") 
d_frame <- frame_format(wide_frame_death) 
c_frame <- frame_format(wide_frame_case) 
# model type
d_meta <- colnames(d_frame)[-c(1:6)]
c_meta <- colnames(c_frame)[-c(1:6)]
## low count
wide_frame_death_low <- read.csv("./data/quantile_frame_bottom.csv") 
wide_frame_case_low <- read.csv("./data/quantile_frame_inc_bottom.csv") 
d_frame_low <- frame_format(wide_frame_death_low) 
c_frame_low <- frame_format(wide_frame_case_low) 
# model type
d_meta_low <- colnames(d_frame_low)[-c(1:6)]
c_meta_low <- colnames(c_frame_low)[-c(1:6)]
```


```{r}
# death forecast
loc_name <-  unique(wide_frame_death[,c("abbreviation","location")])
# calculate distance matrices
q_set <- unique(d_frame$quantile) 
approx_cd_list <- build_distance_frame(d_frame, 
                           horizon_list=c(1:4),
                           target_list="inc death",
                           approx_rule="trapezoid_riemann",
                           tau_F=q_set,tau_G=q_set)

# extract data
total_frame <- approx_cd_list[[1]] %>%
  dplyr::mutate(pair=paste(model_1,model_2,sep=" vs "))
total_frame$target_end_date <- as.Date(total_frame$target_end_date,origin="1970-01-01")

# build some data frame
for(loc in loc_name$location){
  tmp <- approx_cd_list[[2]] %>% 
    dplyr::filter(location==loc) 
  tmp_list <-  lapply(1:4, function(x) cd_matrix(tmp,x))
  assign(paste0("d_frame_loc",loc), tmp)
}

# build heatmaps and scatter plots
for(loc in loc_name$location){
    tmp <- approx_cd_list[[2]] %>%
    dplyr::filter(location==loc)
    assign(paste0("p_",loc),
      distance_heatmap(tmp,
                       paste0(loc_name$abbreviation[which(loc_name$location==loc)],
                                "- Mean Approx. CD - Inc Death Forecasts by Horizon")))
      tmp <-total_frame %>%
          dplyr::filter(location==loc) %>%
          dplyr::group_by(horizon,target_end_date) %>%
          dplyr::filter(model_1 =="COVIDhub-ensemble",
                        model_2 != "COVIDhub-ensemble") %>%
          dplyr:: ungroup()
      assign(paste0("t_",loc),
             scatter(tmp,
            paste0("Approx. CD from COVIDhub-ensemble Over Time  - ",
                loc_name$abbreviation[which(loc_name$location==loc)]) )
    )
}
```

We can visualize the mean approximated pairwise distances across all time points in a heat map shown below. The distance from the model to itself is zero. The $x-$axis is arranged based in an ascending order of the model's approximate pairwise distance from the COVIDhub-ensemble. So, the first model is the model that is most dissimilar (on average) to the ensemble in this time frame.

```{r,fig.align='center'}
# print heatmapes
for(loc in loc_name$location){
  print(do.call(get,list(paste0("p_",loc))))
}
```

We can also look at the approximated pairwise distances to see how the models become more similar or dissimilar over time.

```{r,fig.align='center'}
# print scatterplots
for(loc in loc_name$location){
  print(do.call(get,list(paste0("t_",loc))))
}
```

We can cluster the distances using hierarchical clustering. Different linkages will result in different clusters, we probably should investigate more later. 

```{r}
library(ggdendro)
for(j in 1:5){
for(i in 1:4){
    assign(paste0("dp_",i),
    ggdendrogram(
      hclust(as.dist(get(paste0("d_frame_loc",locs[j]))[[i]]), method = "ward.D", members = NULL)
      ,size = 2) +
      labs(title=paste0("Dendrogram - ",i, " wk ahead inc death - ",loc_name[j]))+
      xlab("") +
      ylab("Mean Cramer's Distance") +
      theme(axis.text.x = element_text(size=5),
            axis.text.y = element_text(size=7),
            plot.margin=unit(c(0,0,0,0),"cm"),
            plot.title = element_text(size=8)))
  } 
  grid.arrange(dp_1,dp_2,dp_3,dp_4,nrow=2)
}
```

## 5 locations with the lowest number of COVID-19 deaths by the end of February 2021

The pairwise approximated Cramer's distances are calculated for the models that have complete submissions for all target, all 5 locations with the lowest number of COVID-19 deaths by the end of February 2021, all probability levels, from the target end date of October, 17th 2020 to May 29th, 2021 .

```{r}
# death forecast
loc_name <-  unique(wide_frame_death_low[,c("abbreviation","location")])
# calculate distance matrices
q_set <- unique(d_frame_low$quantile) 
approx_cd_list <- build_distance_frame(d_frame_low, 
                           horizon_list=c(1:4),
                           target_list="inc death",
                           approx_rule="trapezoid_riemann",
                           tau_F=q_set,tau_G=q_set)

# extract data
total_frame <- approx_cd_list[[1]] %>%
  dplyr::mutate(pair=paste(model_1,model_2,sep=" vs "))
total_frame$target_end_date <- as.Date(total_frame$target_end_date,origin="1970-01-01")

# build some data frame
for(loc in loc_name$location){
  tmp <- approx_cd_list[[2]] %>% 
    dplyr::filter(location==loc) 
  tmp_list <-  lapply(1:4, function(x) cd_matrix(tmp,x))
  assign(paste0("d_frame_loc",loc), tmp)
}

# build heatmaps and scatter plots
for(loc in loc_name$location){
    tmp <- approx_cd_list[[2]] %>%
    dplyr::filter(location==loc)
    assign(paste0("p_",loc),
      distance_heatmap(tmp,
                       paste0(loc_name$abbreviation[which(loc_name$location==loc)],
                                "- Mean Approx. CD - Inc Death Forecasts by Horizon")))
      tmp <-total_frame %>%
          dplyr::filter(location==loc) %>%
          dplyr::group_by(horizon,target_end_date) %>%
          dplyr::filter(model_1 =="COVIDhub-ensemble",
                        model_2 != "COVIDhub-ensemble") %>%
          dplyr:: ungroup()
      assign(paste0("t_",loc),
             scatter(tmp,
            paste0("Approx. CD from COVIDhub-ensemble Over Time  - ",
                loc_name$abbreviation[which(loc_name$location==loc)]) )
    )
}
```

We can visualize the mean approximated pairwise distances across all time points in a heat map shown below. The distance from the model to itself is zero. The $x-$axis is arranged based in an ascending order of the model's approximate pairwise distance from the COVIDhub-ensemble. So, the first model is the model that is most dissimilar (on average) to the ensemble in this time frame.

```{r,fig.align='center'}
# print heatmapes
for(loc in loc_name$location){
  print(do.call(get,list(paste0("p_",loc))))
}
```

We can also look at the approximated pairwise distances to see how the models become more similar or dissimilar over time.

```{r,fig.align='center'}
# print scatterplots
for(loc in loc_name$location){
  print(do.call(get,list(paste0("t_",loc))))
}
```

We can cluster the distances using hierarchical clustering. Different linkages will result in different clusters, we probably should investigate more later. 

```{r}
library(ggdendro)
for(j in 1:5){
for(i in 1:4){
    assign(paste0("dp_",i),
    ggdendrogram(
      hclust(as.dist(get(paste0("d_frame_loc",locs[j]))[[i]]), method = "ward.D", members = NULL)
      ,size = 2) +
      labs(title=paste0("Dendrogram - ",i, " wk ahead inc death - ",loc_name[j]))+
      xlab("") +
      ylab("Mean Cramer's Distance") +
      theme(axis.text.x = element_text(size=5),
            axis.text.y = element_text(size=7),
            plot.margin=unit(c(0,0,0,0),"cm"),
            plot.title = element_text(size=8)))
  } 
  grid.arrange(dp_1,dp_2,dp_3,dp_4,nrow=2)
}
```



# COVID-19 Forecasting Model Similarity Analysis for 1-4 Week Ahead Incident Case 

## 5 locations with the highest number of COVID-19 cumulative cases from 01/25/2020 to 02/07/2021

The pairwise approximated Cramer's distances are calculated for the models that have complete submissions for all target, all probability levels, from mid-October 2020 until May 24th,2021 for 5 locations with the highest cumulative cases.

```{r}
# case forecast
loc_name <-  unique(wide_frame_case_low[,c("abbreviation","location")])
# calculate distance matrices
q_set <- unique(c_frame_low$quantile) 
approx_cd_list <- build_distance_frame(c_frame_low, 
                           horizon_list=c(1:4),
                           target_list="inc case",
                           approx_rule="trapezoid_riemann",
                           tau_F=q_set,tau_G=q_set)

# extract data
total_frame <- approx_cd_list[[1]] %>%
  dplyr::mutate(pair=paste(model_1,model_2,sep=" vs "))
total_frame$target_end_date <- as.Date(total_frame$target_end_date,origin="1970-01-01")

# build some data frame
for(loc in loc_name$location){
  tmp <- approx_cd_list[[2]] %>% 
    dplyr::filter(location==loc) 
  tmp_list <-  lapply(1:4, function(x) cd_matrix(tmp,x))
  assign(paste0("c_frame_loc",loc), tmp)
}

# build heatmaps and scatter plots
for(loc in loc_name$location){
    tmp <- approx_cd_list[[2]] %>%
    dplyr::filter(location==loc)
    assign(paste0("p_",loc),
      distance_heatmap(tmp,
                       paste0(loc_name$abbreviation[which(loc_name$location==loc)],
                                "- Mean Approx. CD - Inc Case Forecasts by Horizon")))
      tmp <-total_frame %>%
          dplyr::filter(location==loc) %>%
          dplyr::group_by(horizon,target_end_date) %>%
          dplyr::filter(model_1 =="COVIDhub-ensemble",
                        model_2 != "COVIDhub-ensemble") %>%
          dplyr:: ungroup()
      assign(paste0("t_",loc),
             scatter(tmp,
            paste0("Approx. CD from COVIDhub-ensemble Over Time  - ",
                loc_name$abbreviation[which(loc_name$location==loc)]) )
    )
}
```

Below are the heat maps of mean approximated pairwise CD across time by location-target:

```{r,fig.align='center'}
# print heatmapes
for(loc in loc_name$location){
  print(do.call(get,list(paste0("p_",loc))))
}
```

Below are the plots of approximated pairwise distances over time. Unlike indicent death targets, there are too many model pairs to show (12 models for inc death and 17 models for inc case, so we have a combination of 6 choose 2 with no repeats (15) vs a combination of 11 choose 2 with no repeats (55)). So, I only pick the first 15 of the combinations:

```{r,fig.align='center'}
for(loc in loc_name$location){
  print(do.call(get,list(paste0("t_",loc))))
}
```


```{r}
library(ggdendro)
for(j in 1:5){
for(i in 1:4){
    assign(paste0("dp_",i),
    ggdendrogram(
      hclust(as.dist(get(paste0("c_frame_loc",locs[j]))[[i]]), method = "ward.D", members = NULL)
      ,size = 2) +
      labs(title=paste0("Dendrogram - ",i, " wk ahead inc case - ",loc_name[j]))+
      xlab("") +
      ylab("Mean Cramer's Distance") +
      theme(axis.text.x = element_text(size=5),
            axis.text.y = element_text(size=7),
            plot.margin=unit(c(0,0,0,0),"cm"),
            plot.title = element_text(size=8)))
  } 
  grid.arrange(dp_1,dp_2,dp_3,dp_4,nrow=2)
}
```

## 5 locations with the lowest number of COVID-19 cases from 01/25/2020 to 02/07/2021

The pairwise approximated Cramer's distances are calculated for the models that have complete submissions for all target, all probability levels, from mid-October 2020 until May 24th,2021 for 5 locations with the lowest cumulative cases.

```{r}
# case forecast
loc_name <-  unique(wide_frame_case[,c("abbreviation","location")])
# calculate distance matrices
q_set <- unique(c_frame$quantile) 
approx_cd_list <- build_distance_frame(c_frame, 
                           horizon_list=c(1:4),
                           target_list="inc case",
                           approx_rule="trapezoid_riemann",
                           tau_F=q_set,tau_G=q_set)

# extract data
total_frame <- approx_cd_list[[1]] %>%
  dplyr::mutate(pair=paste(model_1,model_2,sep=" vs "))
total_frame$target_end_date <- as.Date(total_frame$target_end_date,origin="1970-01-01")

# build some data frame
for(loc in loc_name$location){
  tmp <- approx_cd_list[[2]] %>% 
    dplyr::filter(location==loc) 
  tmp_list <-  lapply(1:4, function(x) cd_matrix(tmp,x))
  assign(paste0("c_frame_loc",loc), tmp)
}

# build heatmaps and scatter plots
for(loc in loc_name$location){
    tmp <- approx_cd_list[[2]] %>%
    dplyr::filter(location==loc)
    assign(paste0("p_",loc),
      distance_heatmap(tmp,
                       paste0(loc_name$abbreviation[which(loc_name$location==loc)],
                                "- Mean Approx. CD - Inc Case Forecasts by Horizon")))
      tmp <-total_frame %>%
          dplyr::filter(location==loc) %>%
          dplyr::group_by(horizon,target_end_date) %>%
          dplyr::filter(model_1 =="COVIDhub-ensemble",
                        model_2 != "COVIDhub-ensemble") %>%
          dplyr:: ungroup()
      assign(paste0("t_",loc),
             scatter(tmp,
            paste0("Approx. CD from COVIDhub-ensemble Over Time  - ",
                loc_name$abbreviation[which(loc_name$location==loc)]) )
    )
}
```

Below are the heatmaps of mean approximated pairwise CD across time by location-target:

```{r,fig.align='center'}
# print heatmapes
for(loc in loc_name$location){
  print(do.call(get,list(paste0("p_",loc))))
}
```

Below are the plots of approximated pairwise distances over time. Unlike indicent death targets, there are too many model pairs to show (12 models for inc death and 17 models for inc case, so we have a combination of 6 choose 2 with no repeats (15) vs a combination of 11 choose 2 with no repeats (55)). So, I only pick the first 15 of the combinations:

```{r,fig.align='center'}
for(loc in loc_name$location){
  print(do.call(get,list(paste0("t_",loc))))
}
```


```{r}
library(ggdendro)
for(j in 1:5){
for(i in 1:4){
    assign(paste0("dp_",i),
    ggdendrogram(
      hclust(as.dist(get(paste0("c_frame_loc",locs[j]))[[i]]), method = "ward.D", members = NULL)
      ,size = 2) +
      labs(title=paste0("Dendrogram - ",i, " wk ahead inc case - ",loc_name[j]))+
      xlab("") +
      ylab("Mean Cramer's Distance") +
      theme(axis.text.x = element_text(size=5),
            axis.text.y = element_text(size=7),
            plot.margin=unit(c(0,0,0,0),"cm"),
            plot.title = element_text(size=8)))
  } 
  grid.arrange(dp_1,dp_2,dp_3,dp_4,nrow=2)
}
```
